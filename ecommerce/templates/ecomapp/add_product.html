{% extends 'ecomapp/base.html' %}
{% load static %}

{% block title %}Add Product - Auto Spares Store{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 40px auto; padding: 20px;">
    <div style="background: white; border-radius: 8px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom: 30px; color: #333; text-align: center;">
            <i class="fas fa-plus-circle"></i> Add New Product
        </h1>

        <!-- Category Management Section (Outside main form to avoid nested forms) -->
        <div id="categoryManagerSection" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; max-width: 600px; margin-left: auto; margin-right: auto;">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-folder-open"></i> Category Management
            </h3>
            
            <!-- Create Category Form -->
            <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <h4 style="margin-top: 0; margin-bottom: 15px; color: #495057;">
                    <i class="fas fa-plus-circle"></i> Create New Category
                </h4>
                <form id="createCategoryForm" style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 10px; align-items: end;">
                    <div>
                        <label for="newCategoryName" style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">
                            Category Name *
                        </label>
                        <input 
                            type="text" 
                            id="newCategoryName" 
                            required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                            placeholder="Enter category name"
                        >
                    </div>
                    <div>
                        <label for="newCategoryDescription" style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">
                            Description (Optional)
                        </label>
                        <input 
                            type="text" 
                            id="newCategoryDescription" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                            placeholder="Enter description"
                        >
                    </div>
                    <div>
                        <button 
                            type="submit" 
                            class="btn btn-success"
                            style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                        >
                            <i class="fas fa-save"></i> Create
                        </button>
                    </div>
                </form>
            </div>

            <!-- Categories List -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <h4 style="margin-top: 0; margin-bottom: 15px; color: #495057;">
                    <i class="fas fa-list"></i> Existing Categories
                </h4>
                <div id="categoriesList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <i class="fas fa-spinner fa-spin"></i> Loading categories...
                    </div>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" style="max-width: 600px; margin: 0 auto;">
            {% csrf_token %}
            
            <div style="margin-bottom: 20px;">
                <label for="name" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                    <i class="fas fa-tag"></i> Product Name *
                </label>
                <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    required 
                    autofocus
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                    placeholder="Enter product name"
                >
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label for="category" style="display: block; color: #555; font-weight: 500; margin: 0;">
                        <i class="fas fa-folder"></i> Category *
                    </label>
                    <button 
                        type="button" 
                        id="toggleCategoryManager" 
                        class="btn btn-sm"
                        style="padding: 6px 12px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
                    >
                        <i class="fas fa-cog"></i> Manage Categories
                    </button>
                </div>
                <select 
                    id="category" 
                    name="category" 
                    required
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                >
                    <option value="">Select a category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="description" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                    <i class="fas fa-align-left"></i> Description *
                </label>
                <textarea 
                    id="description" 
                    name="description" 
                    required
                    rows="4"
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; resize: vertical;"
                    placeholder="Enter product description"
                ></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="price" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                        <i class="fas fa-dollar-sign"></i> Price (R) *
                    </label>
                    <input 
                        type="number" 
                        id="price" 
                        name="price" 
                        required
                        step="0.01"
                        min="0.01"
                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                        placeholder="0.00"
                    >
                </div>
                <div>
                    <label for="stock_quantity" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                        <i class="fas fa-boxes"></i> Stock Quantity *
                    </label>
                    <input 
                        type="number" 
                        id="stock_quantity" 
                        name="stock_quantity" 
                        required
                        min="0"
                        value="0"
                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                        placeholder="0"
                    >
                </div>
            </div>

            <!-- Product Images Section -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                    <i class="fas fa-images"></i> Product Images
                </label>
                <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background: #f8f9fa;">
                    <input 
                        type="file" 
                        id="imageInput" 
                        name="images" 
                        multiple
                        accept="image/*"
                        style="display: none;"
                        onchange="handleImageSelect(event)"
                    >
                    <button 
                        type="button" 
                        onclick="document.getElementById('imageInput').click()"
                        style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-bottom: 15px;"
                    >
                        <i class="fas fa-upload"></i> Upload Images
                    </button>
                    <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                        <!-- Image previews will be added here -->
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #6c757d; text-align: center;">
                        <i class="fas fa-info-circle"></i> You can upload multiple images. First image will be set as primary.
                    </p>
                </div>
            </div>

            <!-- Item Images Section (Optional) -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                    <i class="fas fa-image"></i> Item Images <span style="color: #6c757d; font-weight: normal; font-size: 13px;">(Optional)</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- Item Image 1 -->
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <label for="item_image_1" style="display: block; margin-bottom: 8px; color: #555; font-size: 13px; font-weight: 500;">
                            Item Image 1 (Optional)
                        </label>
                        <input 
                            type="file" 
                            id="item_image_1" 
                            name="item_image_1" 
                            accept="image/*"
                            style="display: none;"
                            onchange="handleItemImageSelect(event, 1)"
                        >
                        <button 
                            type="button" 
                            onclick="document.getElementById('item_image_1').click()"
                            style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 10px;"
                        >
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <div id="itemImagePreview1" style="margin-top: 10px;">
                            <!-- Preview will be added here -->
                        </div>
                    </div>
                    
                    <!-- Item Image 2 -->
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <label for="item_image_2" style="display: block; margin-bottom: 8px; color: #555; font-size: 13px; font-weight: 500;">
                            Item Image 2 (Optional)
                        </label>
                        <input 
                            type="file" 
                            id="item_image_2" 
                            name="item_image_2" 
                            accept="image/*"
                            style="display: none;"
                            onchange="handleItemImageSelect(event, 2)"
                        >
                        <button 
                            type="button" 
                            onclick="document.getElementById('item_image_2').click()"
                            style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 10px;"
                        >
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <div id="itemImagePreview2" style="margin-top: 10px;">
                            <!-- Preview will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 16px;">
                    <i class="fas fa-save"></i> Add Product
                </button>
                <a href="{% url 'store_admin_dashboard' %}" class="btn btn-secondary" style="flex: 1; padding: 12px; font-size: 16px; text-align: center; text-decoration: none;">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.btn {
    display: inline-block;
    padding: 10px 20px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    transition: all 0.2s;
}

.category-item:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.category-info {
    flex: 1;
}

.category-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.category-description {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 4px;
}

.category-meta {
    font-size: 11px;
    color: #868e96;
}

.category-actions {
    display: flex;
    gap: 8px;
}

.edit-form {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr;
    gap: 10px;
    align-items: end;
    padding: 12px;
    background: #fff;
    border-radius: 4px;
    border: 2px solid #007bff;
    margin-bottom: 8px;
}

.alert {
    padding: 12px 16px;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid transparent;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}
</style>

<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// URL patterns for category management
const categoryUrls = {
    manage: '{% url "manage_categories" %}'
};

// Helper function to build update/delete URLs
// Using the known URL pattern: /store-admin/category/<id>/update/ and /store-admin/category/<id>/delete/
function getCategoryUrl(action, categoryId) {
    if (action === 'update') {
        return `/store-admin/category/${categoryId}/update/`;
    } else if (action === 'delete') {
        return `/store-admin/category/${categoryId}/delete/`;
    }
    return categoryUrls.manage;
}

// Helper function to safely parse JSON response
async function parseJsonResponse(response) {
    const text = await response.text();
    try {
        return JSON.parse(text);
    } catch (e) {
        throw new Error(`Invalid JSON response: ${text.substring(0, 100)}`);
    }
}

// Toggle category manager visibility
function toggleCategoryManager() {
    try {
        const section = document.getElementById('categoryManagerSection');
        if (!section) {
            console.error('Category manager section not found');
            showAlert('Error: Category manager section not found', 'error');
            return;
        }
        
        if (section.style.display === 'none' || section.style.display === '') {
            section.style.display = 'block';
            loadCategories();
        } else {
            section.style.display = 'none';
        }
    } catch (error) {
        console.error('Error toggling category manager:', error);
        showAlert('Error: ' + error.message, 'error');
    }
}

// Load categories list
async function loadCategories() {
    const categoriesList = document.getElementById('categoriesList');
    if (!categoriesList) {
        console.error('Categories list element not found');
        return;
    }
    
    categoriesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Loading categories...</div>';
    
    const url = '{% url "manage_categories" %}';
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
            },
        });
        
        const data = await parseJsonResponse(response);
        
        if (!response.ok) {
            throw new Error(data.error || `Server error: ${response.status}`);
        }
        
        if (data.success) {
            displayCategories(data.categories);
            updateCategorySelect(data.categories);
        } else {
            categoriesList.innerHTML = `<div class="alert alert-error">Error loading categories: ${escapeHtml(data.error || 'Unknown error')}</div>`;
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        categoriesList.innerHTML = `<div class="alert alert-error">Error loading categories: ${escapeHtml(error.message)}</div>`;
    }
}

// Display categories in the list
function displayCategories(categories) {
    const categoriesList = document.getElementById('categoriesList');
    if (!categoriesList) return;
    
    if (categories.length === 0) {
        categoriesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No categories found. Create one above!</div>';
        return;
    }
    
    let html = '';
    categories.forEach(category => {
        const categoryName = escapeHtml(category.name);
        const categoryDesc = category.description ? escapeHtml(category.description) : '';
        html += `
            <div class="category-item" id="category-${category.id}" data-category-id="${category.id}">
                <div class="category-info">
                    <div class="category-name">${categoryName}</div>
                    ${category.description ? `<div class="category-description">${categoryDesc}</div>` : ''}
                    <div class="category-meta">${category.product_count} product(s)</div>
                </div>
                <div class="category-actions">
                    <button type="button" 
                            class="btn btn-warning btn-sm edit-category-btn" 
                            data-category-id="${category.id}"
                            data-category-name="${categoryName}"
                            data-category-description="${categoryDesc}"
                            style="padding: 6px 12px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" 
                            class="btn btn-danger btn-sm delete-category-btn" 
                            data-category-id="${category.id}"
                            data-category-name="${categoryName}"
                            style="padding: 6px 12px;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `;
    });
    
    categoriesList.innerHTML = html;
}

// Update category select dropdown
function updateCategorySelect(categories) {
    const select = document.getElementById('category');
    if (!select) return;
    
    const currentValue = select.value;
    
    // Clear existing options except the first one
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Add categories
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
    });
    
    // Restore previous selection if it still exists
    if (currentValue) {
        select.value = currentValue;
    }
}

// Wait for DOM to be ready before attaching event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Attach event listener to toggle button
    const toggleButton = document.getElementById('toggleCategoryManager');
    if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
            e.preventDefault();
            toggleCategoryManager();
        });
    }
    
    // Attach event listener to create category form
    const createCategoryForm = document.getElementById('createCategoryForm');
    if (createCategoryForm) {
        createCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newCategoryName').value.trim();
            const description = document.getElementById('newCategoryDescription').value.trim();
            
            if (!name) {
                showAlert('Category name is required!', 'error');
                return;
            }
            
            const formData = {
                name: name,
                description: description
            };
            
            (async function() {
                try {
                    const response = await fetch('{% url "manage_categories" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await parseJsonResponse(response);
                    
                    if (!response.ok) {
                        throw new Error(data.error || `Server error: ${response.status}`);
                    }
                    
                    if (data.success) {
                        showAlert(data.message || 'Category created successfully!', 'success');
                        document.getElementById('createCategoryForm').reset();
                        await loadCategories();
                        // Select the newly created category in the dropdown
                        const select = document.getElementById('category');
                        if (select && data.category) {
                            // Check if option already exists
                            let optionExists = false;
                            for (let i = 0; i < select.options.length; i++) {
                                if (select.options[i].value == data.category.id) {
                                    optionExists = true;
                                    break;
                                }
                            }
                            // Add option if it doesn't exist
                            if (!optionExists) {
                                const option = document.createElement('option');
                                option.value = data.category.id;
                                option.textContent = data.category.name;
                                select.appendChild(option);
                            }
                            // Select the new category
                            select.value = data.category.id;
                        }
                    } else {
                        showAlert(data.error || 'Error creating category', 'error');
                    }
                } catch (error) {
                    console.error('Error creating category:', error);
                    showAlert('Error creating category: ' + error.message, 'error');
                }
            })();
        });
    }
    
    // Use event delegation for edit and delete buttons
    const categoriesList = document.getElementById('categoriesList');
    if (categoriesList) {
        categoriesList.addEventListener('click', function(e) {
            // Handle edit button clicks
            if (e.target.closest('.edit-category-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const btn = e.target.closest('.edit-category-btn');
                const categoryId = parseInt(btn.getAttribute('data-category-id'));
                const categoryName = btn.getAttribute('data-category-name') || '';
                const categoryDescription = btn.getAttribute('data-category-description') || '';
                editCategory(categoryId, categoryName, categoryDescription);
            }
            // Handle delete button clicks
            else if (e.target.closest('.delete-category-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const btn = e.target.closest('.delete-category-btn');
                const categoryId = parseInt(btn.getAttribute('data-category-id'));
                const categoryName = btn.getAttribute('data-category-name') || '';
                deleteCategory(categoryId, categoryName);
            }
        });
    }
});

// Edit category
function editCategory(id, name, description) {
    const categoryItem = document.getElementById(`category-${id}`);
    if (!categoryItem) {
        console.error('Category item not found:', id);
        showAlert('Error: Category item not found', 'error');
        return;
    }
    
    // Create form container
    const editForm = document.createElement('div');
    editForm.className = 'edit-form';
    editForm.id = `edit-form-${id}`;
    
    // Create name input
    const nameDiv = document.createElement('div');
    const nameLabel = document.createElement('label');
    nameLabel.textContent = 'Category Name *';
    nameLabel.style.cssText = 'display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;';
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.id = `editCategoryName-${id}`;
    nameInput.value = name || '';
    nameInput.required = true;
    nameInput.style.cssText = 'width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;';
    nameDiv.appendChild(nameLabel);
    nameDiv.appendChild(nameInput);
    
    // Create description input
    const descDiv = document.createElement('div');
    const descLabel = document.createElement('label');
    descLabel.textContent = 'Description';
    descLabel.style.cssText = 'display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;';
    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.id = `editCategoryDescription-${id}`;
    descInput.value = description || '';
    descInput.style.cssText = 'width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;';
    descDiv.appendChild(descLabel);
    descDiv.appendChild(descInput);
    
    // Create button container
    const buttonDiv = document.createElement('div');
    buttonDiv.style.cssText = 'display: flex; gap: 5px;';
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-success';
    saveBtn.style.cssText = 'flex: 1; padding: 10px;';
    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
    saveBtn.onclick = function() { saveCategory(id); };
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.style.cssText = 'flex: 1; padding: 10px;';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
    cancelBtn.onclick = function() { cancelEdit(id); };
    
    buttonDiv.appendChild(saveBtn);
    buttonDiv.appendChild(cancelBtn);
    
    // Assemble form
    editForm.appendChild(nameDiv);
    editForm.appendChild(descDiv);
    editForm.appendChild(buttonDiv);
    
    // Replace category item with edit form
    categoryItem.parentNode.replaceChild(editForm, categoryItem);
}

// Save edited category
async function saveCategory(id) {
    if (!id) {
        console.error('Invalid category ID:', id);
        showAlert('Error: Invalid category ID', 'error');
        await loadCategories();
        return;
    }
    
    const nameInput = document.getElementById(`editCategoryName-${id}`);
    const descInput = document.getElementById(`editCategoryDescription-${id}`);
    
    if (!nameInput || !descInput) {
        showAlert('Error: Edit form elements not found', 'error');
        await loadCategories();
        return;
    }
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!name) {
        showAlert('Category name is required!', 'error');
        return;
    }
    
    const formData = {
        name: name,
        description: description
    };
    
    // Build URL using helper function
    const updateUrl = getCategoryUrl('update', id);
    
    if (!updateUrl) {
        showAlert('Error: Invalid update URL', 'error');
        await loadCategories();
        return;
    }
    
    try {
        const response = await fetch(updateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch (e) {
                errorData = { error: `Server error: ${response.status} ${response.statusText}` };
            }
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
        const data = await parseJsonResponse(response);
        
        if (data.success) {
            showAlert(data.message || 'Category updated successfully!', 'success');
            await loadCategories();
            // Update the category dropdown
            const select = document.getElementById('category');
            if (select && data.category) {
                const option = select.querySelector(`option[value="${id}"]`);
                if (option) {
                    option.textContent = data.category.name;
                }
            }
        } else {
            showAlert(data.error || 'Error updating category', 'error');
            // Reload categories to restore the list
            await loadCategories();
        }
    } catch (error) {
        console.error('Error updating category:', error);
        showAlert('Error updating category: ' + error.message, 'error');
        // Reload categories to restore the list
        await loadCategories();
    }
}

// Cancel edit
async function cancelEdit(id) {
    await loadCategories();
}

// Delete category
async function deleteCategory(id, name) {
    if (!id || !name) {
        console.error('Invalid category ID or name:', id, name);
        showAlert('Error: Invalid category information', 'error');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the category "${escapeHtml(name)}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Build URL using helper function
    const deleteUrl = getCategoryUrl('delete', id);
    
    if (!deleteUrl) {
        showAlert('Error: Invalid delete URL', 'error');
        return;
    }
    
    try {
        const response = await fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch (e) {
                errorData = { error: `Server error: ${response.status} ${response.statusText}` };
            }
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
        const data = await parseJsonResponse(response);
        
        if (data.success) {
            showAlert(data.message || 'Category deleted successfully!', 'success');
            await loadCategories();
            // Remove from category dropdown
            const select = document.getElementById('category');
            if (select) {
                const option = select.querySelector(`option[value="${id}"]`);
                if (option) {
                    option.remove();
                }
                // Reset to first option if deleted category was selected
                if (select.value == id) {
                    select.value = '';
                }
            }
        } else {
            showAlert(data.error || 'Error deleting category', 'error');
        }
    } catch (error) {
        console.error('Error deleting category:', error);
        showAlert('Error deleting category: ' + error.message, 'error');
    }
}

// Show alert message
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.3s';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Image upload and preview functionality
let selectedImages = [];

function handleImageSelect(event) {
    const files = event.target.files;
    const container = document.getElementById('imagePreviewContainer');
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showAlert('Please select only image files.', 'error');
            continue;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showAlert(`Image "${file.name}" is too large. Maximum size is 5MB.`, 'error');
            continue;
        }
        
        // Check if file is already selected
        const isDuplicate = selectedImages.some(img => img.file.name === file.name && img.file.size === file.size);
        if (isDuplicate) {
            showAlert(`Image "${file.name}" is already selected.`, 'error');
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = {
                id: Date.now() + i,
                file: file,
                preview: e.target.result
            };
            selectedImages.push(imageData);
            renderImagePreview(imageData);
            // Update file input to include all selected images
            updateFileInput();
        };
        reader.readAsDataURL(file);
    }
    
    // Reset input to allow selecting the same file again
    event.target.value = '';
}

function renderImagePreview(imageData) {
    const container = document.getElementById('imagePreviewContainer');
    
    const imageDiv = document.createElement('div');
    imageDiv.id = `image-preview-${imageData.id}`;
    imageDiv.style.cssText = 'position: relative; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: white;';
    
    const img = document.createElement('img');
    img.src = imageData.preview;
    img.style.cssText = 'width: 100%; height: 120px; object-fit: cover; display: block;';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
    deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);';
    deleteBtn.onclick = function() {
        removeImage(imageData.id);
    };
    
    imageDiv.appendChild(img);
    imageDiv.appendChild(deleteBtn);
    container.appendChild(imageDiv);
}

function removeImage(imageId) {
    // Remove from selectedImages array
    selectedImages = selectedImages.filter(img => img.id !== imageId);
    
    // Remove from DOM
    const imageDiv = document.getElementById(`image-preview-${imageId}`);
    if (imageDiv) {
        imageDiv.remove();
    }
    
    // Update file input (create new input with remaining files)
    updateFileInput();
}

function updateFileInput() {
    // Create a new DataTransfer object
    const dataTransfer = new DataTransfer();
    
    // Add remaining files
    selectedImages.forEach(img => {
        dataTransfer.items.add(img.file);
    });
    
    // Update the file input
    const fileInput = document.getElementById('imageInput');
    fileInput.files = dataTransfer.files;
}

// Handle item image selection and preview
function handleItemImageSelect(event, imageNumber) {
    const file = event.target.files[0];
    const previewContainer = document.getElementById(`itemImagePreview${imageNumber}`);
    
    if (!file) {
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showAlert('Please select only image files.', 'error');
        event.target.value = '';
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showAlert(`Image "${file.name}" is too large. Maximum size is 5MB.`, 'error');
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        previewContainer.innerHTML = `
            <div style="position: relative; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: white;">
                <img src="${e.target.result}" style="width: 100%; height: 150px; object-fit: cover; display: block;">
                <button 
                    type="button" 
                    onclick="removeItemImage(${imageNumber})"
                    style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    };
    reader.readAsDataURL(file);
}

// Remove item image
function removeItemImage(imageNumber) {
    const input = document.getElementById(`item_image_${imageNumber}`);
    const previewContainer = document.getElementById(`itemImagePreview${imageNumber}`);
    
    if (input) {
        input.value = '';
    }
    if (previewContainer) {
        previewContainer.innerHTML = '';
    }
}

// Update form submission to ensure images are properly attached
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Ensure file input has all selected images before submission
            const fileInput = document.getElementById('imageInput');
            if (fileInput && selectedImages.length > 0) {
                // Create a new DataTransfer object
                const dataTransfer = new DataTransfer();
                
                // Add all selected files
                selectedImages.forEach(img => {
                    dataTransfer.items.add(img.file);
                });
                
                // Update the file input with all files
                fileInput.files = dataTransfer.files;
            }
        });
    }
});
</script>
{% endblock %}

